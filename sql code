CREATE TABLE Artist (
    ArtistId INTEGER PRIMARY KEY,
    Name VARCHAR(120)
);

CREATE TABLE Album (
    AlbumId INTEGER PRIMARY KEY,
    Title VARCHAR(160),
    ArtistId INTEGER REFERENCES Artist(ArtistId)
);
CREATE TABLE Customer (
    CustomerId INTEGER PRIMARY KEY,
    FirstName VARCHAR(40),
    LastName VARCHAR(40),
    Company VARCHAR(80),
    Address VARCHAR(70),
    City VARCHAR(40),
    State VARCHAR(40),
    Country VARCHAR(40),
    PostalCode VARCHAR(10),
    Phone VARCHAR(24),
    Fax VARCHAR(24),
    Email VARCHAR(60),
    SupportRepId INTEGER
);
CREATE TABLE Employee (
    EmployeeId INTEGER PRIMARY KEY,
    LastName VARCHAR(20),
    FirstName VARCHAR(20),
    Title VARCHAR(30),
    ReportsTo INTEGER,
    Address VARCHAR(70),
    City VARCHAR(40),
    State VARCHAR(40),
    Country VARCHAR(40),
    PostalCode VARCHAR(10),
    Phone VARCHAR(24),
    Fax VARCHAR(24),
    Email VARCHAR(60)
);

CREATE TABLE Genre (
    GenreId INTEGER PRIMARY KEY,
    Name VARCHAR(120)
);
CREATE TABLE Invoice (
    InvoiceId INTEGER PRIMARY KEY,
    CustomerId INTEGER,
    BillingAddress VARCHAR(70),
    BillingCity VARCHAR(40),
    BillingState VARCHAR(40),
    BillingCountry VARCHAR(40),
    BillingPostalCode VARCHAR(10),
    Total NUMERIC(10, 2)
);
CREATE TABLE InvoiceLine (
    InvoiceLineId INTEGER PRIMARY KEY,
    InvoiceId INTEGER,
    TrackId INTEGER,
    UnitPrice NUMERIC(10, 2),
    Quantity INTEGER
);
CREATE TABLE MediaType (
    MediaTypeId INTEGER PRIMARY KEY,
    Name VARCHAR(120)
);

CREATE TABLE Playlist (
    PlaylistId INTEGER PRIMARY KEY,
    Name VARCHAR(120)
);
CREATE TABLE PlaylistTrack (
    PlaylistId INTEGER,
    TrackId INTEGER,
    PRIMARY KEY (PlaylistId, TrackId)
);
CREATE TABLE Track (
    TrackId INTEGER PRIMARY KEY,
    Name VARCHAR(200),
    AlbumId INTEGER,
    MediaTypeId INTEGER,
    GenreId INTEGER,
    Composer VARCHAR(220),
    Milliseconds INTEGER,
    Bytes INTEGER,
    UnitPrice NUMERIC(10, 2)
);


SELECT SUM(Total) AS TotalRevenue
FROM Invoice;
SELECT BillingCountry, SUM(Total) AS Revenue
FROM Invoice
GROUP BY BillingCountry
ORDER BY Revenue DESC;

SELECT FirstName || ' ' || LastName AS CustomerName, SUM(Total) AS Revenue
FROM Customer
JOIN Invoice ON Customer.CustomerId = Invoice.CustomerId
GROUP BY CustomerName
ORDER BY Revenue DESC
LIMIT 5;

SELECT 
    Track.Name AS TrackName,
    SUM(InvoiceLine.UnitPrice * InvoiceLine.Quantity) AS TotalRevenue
FROM 
    InvoiceLine
JOIN 
    Track ON InvoiceLine.TrackId = Track.TrackId
GROUP BY 
    Track.Name
ORDER BY 
    TotalRevenue DESC
LIMIT 10;

SELECT 
    Album.Title AS AlbumTitle,
    COUNT(InvoiceLine.InvoiceLineId) AS UnitsSold
FROM 
    InvoiceLine
JOIN 
    Track ON InvoiceLine.TrackId = Track.TrackId
JOIN 
    Album ON Track.AlbumId = Album.AlbumId
GROUP BY 
    Album.Title
ORDER BY 
    UnitsSold DESC
LIMIT 10;
SELECT *
FROM (
    SELECT 
        Genre.Name AS GenreName,
        Track.Name AS TrackName,
        SUM(InvoiceLine.Quantity) AS UnitsSold,
        RANK() OVER (
            PARTITION BY Genre.Name 
            ORDER BY SUM(InvoiceLine.Quantity) DESC
        ) AS Rank
    FROM 
        InvoiceLine
    JOIN 
        Track ON InvoiceLine.TrackId = Track.TrackId
    JOIN 
        Genre ON Track.GenreId = Genre.GenreId
    GROUP BY 
        Genre.Name, Track.Name
) AS ranked_tracks
WHERE Rank = 1;
